<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>お問い合わせ 管理ダッシュボード</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;color:#111;margin:0;padding:20px}
  #loginBox{max-width:360px;margin:80px auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.06);text-align:center}
  #dashboard{display:none;max-width:1100px;margin:20px auto}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .card{background:#fff;padding:14px;border-radius:10px;margin-bottom:12px;box-shadow:0 4px 12px rgba(2,6,23,0.04)}
  .meta{color:#6b7280;font-size:13px}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  .btn-danger{background:#ef4444;color:#fff}
  .btn-secondary{background:#e6e9ef}
  .actions{display:flex;gap:8px;margin-top:10px}
  .search{margin-bottom:12px}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#0f62fe;font-weight:700}
</style>
</head>
<body>

<div id="loginBox">
  <h2>管理ダッシュボードにログイン</h2>
  <p>管理パスワードを入力してください</p>
  <input id="passwordInput" type="password" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px" placeholder="管理パスワード">
  <button id="loginBtn" class="btn" style="background:#0f62fe;color:#fff;padding:10px 14px;border-radius:8px;border:none">ログイン</button>
  <p id="loginError" style="color:#ef4444"></p>
  <p style="margin-top:10px;font-size:13px;color:#6b7280">※ 初回は簡易パスワード方式です。URLは必ず秘匿してください。</p>
</div>

<div id="dashboard">
  <div class="header">
    <div>
      <h2 style="margin:0">お問い合わせ一覧</h2>
      <div class="meta">Firestore → collection: <strong>inquiries</strong></div>
    </div>
    <div style="text-align:right">
      <span class="badge">簡易管理</span>
      <div style="font-size:13px;color:#6b7280;margin-top:6px">現在表示中： <span id="count">0</span></div>
    </div>
  </div>

  <div class="card search">
    <input id="q" placeholder="名前／メール／サービスで検索" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
  </div>

  <div id="list"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/*
  ====== 設定 ======
  firebaseConfig をあなたの Firebase プロジェクト情報に置き換えてください
  (lp-office-firebase.html と同じ設定)
*/
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// 管理パスワード（必ず変更）
const ADMIN_PASSWORD = "kanaty04"; // ← 必ず変更してください

/* 初期化 */
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ログイン処理（簡易） */
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
loginBtn.addEventListener('click', () => {
  const val = document.getElementById('passwordInput').value;
  if (val === ADMIN_PASSWORD) {
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    startListening();
  } else {
    loginError.textContent = 'パスワードが違います';
  }
});

/* リアルタイム購読 */
let unsubscribe = null;
function startListening() {
  const listEl = document.getElementById('list');
  const countEl = document.getElementById('count');

  unsubscribe = db.collection('inquiries').orderBy('created_at', 'desc')
    .onSnapshot((snap) => {
      listEl.innerHTML = '';
      countEl.textContent = snap.size;
      snap.forEach(doc => {
        const d = doc.data();
        const created = d.created_at && d.created_at.toDate ? d.created_at.toDate().toLocaleString() : '-';
        const read = d.read ? true : false;

        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
            <div>
              <div style="font-weight:700">${escapeHtml(d.name || '（名無し）')} <span style="font-weight:400;color:#6b7280;font-size:13px">(${escapeHtml(d.email || '-')})</span></div>
              <div style="color:#6b7280;margin-top:6px">${escapeHtml(d.service || '')} ・ <span style="font-size:13px">${created}</span></div>
            </div>
            <div style="text-align:right">
              <div style="margin-bottom:8px">${read ? '<span style=\"color:#059669;font-weight:700\">既読</span>' : '<span style=\"color:#f59e0b;font-weight:700\">未読</span>'}</div>
              <div class="actions">
                <button class="btn btn-secondary" data-id="${doc.id}" data-action="toggle">${read ? '未読に戻す' : '既読にする'}</button>
                <button class="btn btn-danger" data-id="${doc.id}" data-action="delete">削除</button>
              </div>
            </div>
          </div>
          <div style="margin-top:10px;white-space:pre-wrap">${escapeHtml(d.message || '')}</div>
        `;
        listEl.appendChild(el);
      });

      // attach handlers
      document.querySelectorAll('button[data-action]').forEach(b => {
        b.onclick = async (ev) => {
          const id = b.getAttribute('data-id');
          const action = b.getAttribute('data-action');
          if (action === 'delete') {
            if (!confirm('本当に削除しますか？')) return;
            try { await db.collection('inquiries').doc(id).delete(); }
            catch(err){ alert('削除に失敗しました'); console.error(err); }
          } else if (action === 'toggle') {
            try {
              const ref = db.collection('inquiries').doc(id);
              const docSnap = await ref.get();
              const cur = docSnap.exists && docSnap.data().read;
              await ref.update({ read: !cur });
            } catch(err){ alert('操作に失敗しました'); console.error(err); }
          }
        };
      });

    }, (err) => {
      console.error('Snapshot error', err);
    });
}

/* simple search (client-side) */
document.getElementById('q').addEventListener('input', (e)=> {
  const q = e.target.value.toLowerCase();
  const cards = document.querySelectorAll('#list .card');
  cards.forEach(c => {
    const text = c.innerText.toLowerCase();
    c.style.display = text.indexOf(q) !== -1 ? 'block' : 'none';
  });
});

/* escape html helper */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

</script>

</body>
</html>

