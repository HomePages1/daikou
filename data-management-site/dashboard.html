<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>管理者ダッシュボード｜お問い合わせ管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- 検索に出さない -->
  <meta name="robots" content="noindex,nofollow">

  <!-- CSS（共通） -->
  <link rel="stylesheet" href="/css/style.css">

  <style>
    body { background:#f4f6f8; }
    .login-box {
      max-width:360px;
      margin:100px auto;
      background:#fff;
      padding:20px;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
      text-align:center;
    }
    .dashboard {
      max-width:1100px;
      margin:30px auto;
      display:none;
    }
    .card { margin-bottom:14px; }
    .actions { display:flex; gap:8px; }
    .badge-new { color:#d97706; font-weight:700; }
    .badge-read { color:#059669; font-weight:700; }
  </style>
</head>

<body>

<!-- ログイン -->
<div class="login-box" id="loginBox">
  <h2>管理者ログイン</h2>
  <p class="small">管理用パスワードを入力してください</p>
  <input id="adminPass" type="password" placeholder="パスワード">
  <button class="btn primary" onclick="login()">ログイン</button>
  <p id="loginError" class="small" style="color:red"></p>
</div>

<!-- ダッシュボード -->
<div class="dashboard" id="dashboard">
  <h1>お問い合わせ管理</h1>
  <p class="small">Firestore / inquiries</p>

  <div id="count" class="small"></div>

  <div id="list"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ===== Firebase設定 ===== */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== 管理パスワード ===== */
const ADMIN_PASSWORD = "CHANGE_THIS_PASSWORD";

/* ===== ログイン ===== */
function login(){
  const val = document.getElementById('adminPass').value;
  if(val === ADMIN_PASSWORD){
    document.getElementById('loginBox').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    loadData();
  } else {
    document.getElementById('loginError').textContent = 'パスワードが違います';
  }
}

/* ===== データ取得 ===== */
function loadData(){
  const list = document.getElementById('list');
  const count = document.getElementById('count');

  db.collection('inquiries')
    .orderBy('created_at','desc')
    .onSnapshot(snap => {
      list.innerHTML = '';
      count.textContent = `件数：${snap.size}`;

      snap.forEach(doc => {
        const d = doc.data();
        const card = document.createElement('div');
        card.className = 'card';

        card.innerHTML = `
          <strong>${escape(d.name)}</strong>
          <div class="small">${escape(d.email)} / ${escape(d.service)}</div>
          <div class="small">${escape(d.message)}</div>
          <div class="small">
            ${d.read ? '<span class="badge-read">既読</span>' : '<span class="badge-new">未読</span>'}
          </div>
          <div class="actions">
            <button class="btn" onclick="toggleRead('${doc.id}', ${!!d.read})">
              ${d.read ? '未読に戻す' : '既読にする'}
            </button>
            <button class="btn danger" onclick="remove('${doc.id}')">削除</button>
          </div>
        `;
        list.appendChild(card);
      });
    });
}

/* ===== 操作 ===== */
function toggleRead(id, cur){
  db.collection('inquiries').doc(id).update({ read: !cur });
}
function remove(id){
  if(confirm('削除しますか？')){
    db.collection('inquiries').doc(id).delete();
  }
}

/* ===== XSS対策 ===== */
function escape(s){
  if(!s) return '';
  return s.replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
</script>

</body>
</html>
